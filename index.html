<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="">
    <link href="https://fonts.googleapis.com/css?family=Arimo&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://d3js.org/d3.v5.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link rel="stylesheet" href="./index.css">
  </head>
  <body>
    <main class="main-container">
      <div class="main-wrapper">
        <div class="chart-area">
          <div class="main-chart"></div>
          <div class="timeline-chart"></div>
        </div>
        <div class="story-area">
          <div class="story-container">
            <div class="story story--full" data-aos="flip-left">
              <h4>
                FLUTTER
              </h4>
              <h3>
                Top 8 Announcements from Flutter Interact
              </h3>
              <p>
                So the Flutter Interact 19 is ended with amazing cool stuffs and announcements therefore I bring you the Top 8.
              </p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--half story--left" data-aos="fade-right">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>WORK</h4>
              <h3>
                Master the JavaScript Interview: What is a Promise?
              </h3>
              <p>“Master the JavaScript Interview” is a series of posts designed to prepare candidates for common questions they are likely to encounter…</p>
            </div>
            <div class="story story--half story--right" data-aos="fade-left">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--full" data-aos="flip-right">
                <div class="story-cover">
                  <div style="background-image: url('https://via.placeholder.com/300');"></div>
                </div>
                <h4>ENVIRONMENT</h4>
                <h3>
                    The Asteroid No One Is Talking About
                </h3>
                <p>It either has a 0% or 92% chance of hitting Earth in 2062.</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--half story--left" data-aos="fade-right">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
            <div class="story story--half story--right" data-aos="fade-left">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--half story--left" data-aos="fade-right">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
            <div class="story story--half story--right" data-aos="fade-left">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--full" data-aos="flip-right">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--half story--left" data-aos="fade-right">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>ENVIRONMENT</h4>
              <h3>
                  The Asteroid No One Is Talking About
              </h3>
              <p>It either has a 0% or 92% chance of hitting Earth in 2062.</p>
            </div>
            <div class="story story--half story--right" data-aos="fade-left">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>ENVIRONMENT</h4>
              <h3>
                  The Asteroid No One Is Talking About
              </h3>
              <p>It either has a 0% or 92% chance of hitting Earth in 2062.</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--half story--left" data-aos="zoom-in-right">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>ENVIRONMENT</h4>
              <h3>
                  The Asteroid No One Is Talking About
              </h3>
              <p>It either has a 0% or 92% chance of hitting Earth in 2062.</p>
            </div>
            <div class="story story--half story--right" data-aos="zoom-in-left">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--full" data-aos="flip-right">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--half story--left" data-aos="fade-right">
              <h4>Based on your reading history</h4>
              <h3>
                How Japanese Manufacturing Influenced Agile: A brief Explanation on Scrum vs Kanban
              </h3>
              <p>When we talk about products, we think of them in two different ways, either as physical products that are manufactured or software…</p>
            </div>
            <div class="story story--half story--right" data-aos="fade-left">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>ENVIRONMENT</h4>
              <h3>
                  The Asteroid No One Is Talking About
              </h3>
              <p>It either has a 0% or 92% chance of hitting Earth in 2062.</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--half story--left" data-aos="fade-right">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>ENVIRONMENT</h4>
              <h3>
                  The Asteroid No One Is Talking About
              </h3>
              <p>It either has a 0% or 92% chance of hitting Earth in 2062.</p>
            </div>
            <div class="story story--half story--right" data-aos="fade-left">
              <div class="story-cover">
                <div style="background-image: url('https://via.placeholder.com/300');"></div>
              </div>
              <h4>ENVIRONMENT</h4>
              <h3>
                  The Asteroid No One Is Talking About
              </h3>
              <p>It either has a 0% or 92% chance of hitting Earth in 2062.</p>
            </div>
          </div>
          <div class="story-container">
            <div class="story story--full" data-aos="zoom-in-up">
              END OF STORY
            </div>
          </div>
        </div>
      </div>

    </main>
  </body>

  <script>
    AOS.init();

    const VIEWPORT_PADDING = 20;
    const CHART_HEIGHT = 250;
    const CHART_PADDING = 32;
    const DAYS_RANGE = 14;
    const BRUSH_HEIGHT = 70;
    const PEAK_LABEL_LINE_HEIGHT = 25;

    const MAX_CHART_WIDTH = 860;
    const LARGE_DESKTOP_VIEWPORT = 1000;

    const MAIN_CHART_OPACITY_OFF = '0.15';
    const MAIN_CHART_OPACITY_ON = '1';

    const PEAK_LABEL_OPACITY_OFF = '0';
    const PEAK_LABEL_OPACITY_ON = '1';

    const DOT_OPACITY_OFF = '0';
    const DOT_OPACITY_ON = '1';

    function getViewportWidth() {
      return window.innerWidth
        || document.documentElement.clientWidth
        || document.body.clientWidth;
    }

    function inLargeDesktopViewport() {
      return getViewportWidth() >= LARGE_DESKTOP_VIEWPORT;
    }

    function addDays(currentDate, dayNum) {
      return new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + dayNum, currentDate.getHours(), currentDate.getMinutes());
    }

    function generateColor(index) {
      const colors = [
        '#EF7EC4',
        '#87FBFB',
        '#86F69B',
        '#F8C06B',
        '#91A9F8',
        '#46A7AC',
        '#EA88D8',
        '#DBF76B',
        '#B195F8',
        '#C2185B',
        '#821D38',
      ];
      return colors[index % colors.length];
    }

    const overallData = [
      { time: '2019-01-01T00:00:00.108Z', id: '1', title: 'Jokowi', interest: 0 },
      { time: '2019-01-02T00:00:00.108Z', id: '1', title: 'Jokowi', interest: 0.4 },
      { time: '2019-01-03T00:00:00.108Z', id: '1', title: 'Jokowi', interest: 0.1 },
      { time: '2019-01-04T00:00:00.108Z', id: '1', title: 'Jokowi', interest: 0.2 },
      { time: '2019-01-05T00:00:00.108Z', id: '1', title: 'Jokowi', interest: 0 },

      { time: '2019-01-02T00:00:00.108Z', id: '2', title: 'Jokowi', interest: 0 },
      { time: '2019-01-03T00:00:00.108Z', id: '2', title: 'Jokowi', interest: 0.3 },
      { time: '2019-01-04T00:00:00.108Z', id: '2', title: 'Jokowi', interest: 0.4 },
      { time: '2019-01-05T00:00:00.108Z', id: '2', title: 'Jokowi', interest: 0.5 },
      { time: '2019-01-06T00:00:00.108Z', id: '2', title: 'Jokowi', interest: 0.15 },
      { time: '2019-01-07T00:00:00.108Z', id: '2', title: 'Jokowi', interest: 0.25 },
      { time: '2019-01-08T00:00:00.108Z', id: '2', title: 'Jokowi', interest: 0 },

      { time: '2019-01-13T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0 },
      { time: '2019-01-14T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.6 },
      { time: '2019-01-15T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.51 },
      { time: '2019-01-16T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.4 },
      { time: '2019-01-17T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.43 },
      { time: '2019-01-18T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.25 },
      { time: '2019-01-19T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.73 },
      { time: '2019-01-20T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.2 },
      { time: '2019-01-21T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0 },
      { time: '2019-01-22T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.15 },
      { time: '2019-01-23T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.35 },
      { time: '2019-01-24T00:00:00.108Z', id: '3', title: 'Jokowi', interest: 0.4 },

      { time: '2019-01-17T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0 },
      { time: '2019-01-18T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.5 },
      { time: '2019-01-19T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.4 },
      { time: '2019-01-20T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.2 },
      { time: '2019-01-21T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.7 },
      { time: '2019-01-22T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.4 },
      { time: '2019-01-23T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.4 },
      { time: '2019-01-24T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.5 },
      { time: '2019-01-25T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.56 },
      { time: '2019-01-26T00:00:00.108Z', id: '4', title: 'Jokowi', interest: 0.2 },

      { time: '2019-01-20T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0 },
      { time: '2019-01-21T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.23 },
      { time: '2019-01-22T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.23 },
      { time: '2019-01-23T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.45 },
      { time: '2019-01-24T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.85 },
      { time: '2019-01-25T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.22 },
      { time: '2019-01-26T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.56 },
      { time: '2019-01-27T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.2 },
      { time: '2019-01-28T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.3 },
      { time: '2019-01-29T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0.35 },
      { time: '2019-01-30T00:00:00.108Z', id: '5', title: 'Jokowi', interest: 0 },

      { time: '2019-02-01T00:00:00.108Z', id: '6', title: 'Jokowi', interest: 0.25 },
      { time: '2019-02-02T00:00:00.108Z', id: '6', title: 'Jokowi', interest: 0.54 },
      { time: '2019-02-03T00:00:00.108Z', id: '6', title: 'Jokowi', interest: 0.2 },
      { time: '2019-02-04T00:00:00.108Z', id: '6', title: 'Jokowi', interest: 0.4 },

      { time: '2019-02-04T00:00:00.108Z', id: '7', title: 'Jokowi', interest: 0.56 },
      { time: '2019-02-05T00:00:00.108Z', id: '7', title: 'Jokowi', interest: 0.23 },
      { time: '2019-02-06T00:00:00.108Z', id: '7', title: 'Jokowi', interest: 0.5 },
      { time: '2019-02-07T00:00:00.108Z', id: '7', title: 'Jokowi', interest: 0.6 },
      { time: '2019-02-08T00:00:00.108Z', id: '7', title: 'Jokowi', interest: 0.45 },
      { time: '2019-02-09T00:00:00.108Z', id: '7', title: 'Jokowi', interest: 0.25 },
      { time: '2019-02-10T00:00:00.108Z', id: '7', title: 'Jokowi', interest: 0.24 },

      { time: '2019-02-09T00:00:00.108Z', id: '8', title: 'Jokowi', interest: 0.25 },
      { time: '2019-02-10T00:00:00.108Z', id: '8', title: 'Jokowi', interest: 0.5 },
      { time: '2019-02-11T00:00:00.108Z', id: '8', title: 'Jokowi', interest: 0.25 },
      { time: '2019-02-12T00:00:00.108Z', id: '8', title: 'Jokowi', interest: 0.65 },

      { time: '2019-02-11T00:00:00.108Z', id: '9', title: 'Jokowi', interest: 0.13 },
      { time: '2019-02-12T00:00:00.108Z', id: '9', title: 'Jokowi', interest: 0.2 },
      { time: '2019-02-13T00:00:00.108Z', id: '9', title: 'Jokowi', interest: 0.7 },
      { time: '2019-02-14T00:00:00.108Z', id: '9', title: 'Jokowi', interest: 0.54 },

      { time: '2019-02-14T00:00:00.108Z', id: '10', title: 'Jokowi', interest: 0.25 },
      { time: '2019-02-15T00:00:00.108Z', id: '10', title: 'Jokowi', interest: 0.15 },
      { time: '2019-02-16T00:00:00.108Z', id: '10', title: 'Jokowi', interest: 0.25 },
      { time: '2019-02-17T00:00:00.108Z', id: '10', title: 'Jokowi', interest: 0.7 },
      { time: '2019-02-18T00:00:00.108Z', id: '10', title: 'Jokowi', interest: 0.2 },
      { time: '2019-02-19T00:00:00.108Z', id: '10', title: 'Jokowi', interest: 0.34 },
      { time: '2019-02-20T00:00:00.108Z', id: '10', title: 'Jokowi', interest: 0 },
    ];

    const articles = {
      '1': 'Comics',
      '2': 'Culture',
      '3': 'Fiction',
      '4': 'Music',
      '5': 'Poetry',
      '6': 'Podcast',
      '7': 'Writing',
      '8': 'News & Entertainment',
      '9': 'Business',
      '10': 'Design',
    };

    const grouped = _.groupBy(overallData, 'id');
    let chunks = Object.keys(grouped).map(item => ({
      key: item,
      title: articles[item],
      items: grouped[item],
    }));

    const minDate = d3.min(overallData, function(d) { return new Date(d.time) });
    const maxDate = d3.max(overallData, function(d) { return new Date(d.time) });

    this.timelineChart = {};
    this.timelineChart.initMainChart = function() {
      var self = this;
      this.svgWidth = inLargeDesktopViewport() ? MAX_CHART_WIDTH : getViewportWidth() - VIEWPORT_PADDING;

      this.selectedMinDate = addDays(minDate, 10);
      this.selectedMaxDate = addDays(this.selectedMinDate, DAYS_RANGE);

      this.drawMainChart();
      this.drawMainXAxis();
      this.drawMainYAxis();
      this.drawMainPeakLabel();
      this.drawDots();
    }

    this.timelineChart.resize = function(e) {
      var self = this;
      this.svgWidth = inLargeDesktopViewport() ? MAX_CHART_WIDTH : getViewportWidth() - VIEWPORT_PADDING;
      this.mainChartSvg
        .attr('width', this.svgWidth)
        .attr('height', CHART_HEIGHT + CHART_PADDING);

      this.mainX
        .range([0, this.svgWidth - CHART_PADDING]);

      this.mainY
        .range([CHART_HEIGHT, 0]);
      
      this.timelineX
        .range([0, this.svgWidth - CHART_PADDING - 1])
      
      this.mainChartArea
        .x(function(d, i) { return self.mainX(new Date(d.time)); })
        .y0(self.mainY(0))
        .y1(function(d, i) { return self.mainY(d.interest) })
    }

    this.timelineChart.filterDataRelativeToPeakByRange = function(datas, shift) {
      var self = this;
      const output = datas.filter(function(chunk) {
        const sortedItems = chunk.items.slice().sort(function(a, b) { return a.interest - b.interest });
        const peakObj = sortedItems[sortedItems.length - 1];
        const peakDate = new Date(peakObj.time);
        return addDays(peakDate, shift) >= self.selectedMinDate && addDays(peakDate, -shift) <= self.selectedMaxDate;
      });

      return output.slice(0);
    }

    this.timelineChart.filterDataByRange = function(datas) {
      var self = this;
      const output = datas.filter(function(item) {
        const date = new Date(item.time);
        return date >= self.selectedMinDate && date <= self.selectedMaxDate && item.interest > 0;
      });

      return output.slice(0);
    }

    this.timelineChart.drawMainChart = function() {
      var self = this;
      this.mainX = d3.scaleTime()
        .range([0, this.svgWidth - CHART_PADDING])
        .domain([this.selectedMinDate, this.selectedMaxDate]);
      this.mainY = d3.scaleLinear()
        .domain([0, 1])
        .range([CHART_HEIGHT, 0]);

      this.timelineX = d3.scaleTime()
        .range([0, this.svgWidth - CHART_PADDING - 1])
        .domain([minDate, maxDate])

      this.timelineY = d3.scaleLinear()
        .domain([0, 1])
        .range([`${BRUSH_HEIGHT}`, 0]);

      this.mainChartSvg = d3
        .select('.main-chart')
        .append('svg')
        .attr('width', this.svgWidth)
        .attr('height', CHART_HEIGHT + CHART_PADDING);
    
      this.mainChartGroup = this.mainChartSvg
        .append('g')
        .attr('transform', `translate(0, 8)`)
        .attr('class', '.main-chart-area');

      this.mainChartSelection = this.mainChartGroup
        .append('g')
        .attr('transform', `translate(${CHART_PADDING + 2}, 0)`)
        .selectAll('path')
        .data(chunks)
        .enter();

      this.mainChartArea = d3.area()
        .x(function(d, i) { return self.mainX(new Date(d.time)); })
        .y0(self.mainY(0))
        .y1(function(d, i) { return self.mainY(d.interest) })
        .defined(function(d) {
          return addDays(new Date(d.time), 1) > self.selectedMinDate && addDays(new Date(d.time), -1) < self.selectedMaxDate;
        });

      this.mainChartPath = this.mainChartSelection
        .append('path')
        .attr('class', 'timeline-chart-area')
        .attr('fill', function(d, i) {
          return generateColor(i);
        })
        .datum(function(d) { return d; })
        .attr("d", function(d) {
          return self.mainChartArea(d.items);
        })
        .on('mouseover', function (d, i) {
          self.mouseOverArea(d.key, i);
        })
        .on('mouseout', function (d, i) {
          self.mouseOutArea();
        });
    }

    this.timelineChart.drawMainPeakLabel = function() {
      var self = this;
      
      this.peakLabelGroup = this.mainChartSvg
        .append('g')
        .attr('class', 'chart-peak-label-group');

      this.peakLabelSelection = this.peakLabelGroup
        .selectAll('.chart-peak-label')
        .data(this.filterDataRelativeToPeakByRange(chunks, 3))
        .enter()
        .append('g')
        .attr('class', 'chart-peak-label');

      this.peakLabelSelection
        .attr('transform', function(d) {
          const obj = d.items.slice().sort(function(a, b) { return a.interest - b.interest })[d.items.length - 1];
          return `translate(${self.mainX(new Date(obj.time)) + CHART_PADDING + 1.5}, ${self.mainY(obj.interest) - (CHART_PADDING / 2)})`;
        })
        .append('rect')
        .attr('width', 1)
        .attr('height', PEAK_LABEL_LINE_HEIGHT)
        .attr('fill', '#999')
        .attr('shape-rendering', 'crispEdges');
      
      this.peakLabelSelection
        .append('text')
        .attr('y', '-15')
        .attr('fill', '#3A3A3A')
        .attr('text-anchor', 'start')
        .attr('dominant-baseline', 'text-before-edge')
        .text(function(d, i) {
          return d.title;
        })
        .attr('transform', function(d) {
          const w = this.getComputedTextLength();
          return `translate(${-(w/2)}, 0)`
        });
    }

    this.timelineChart.updatePeakLabels = function() {
      var self = this;
      this.peakLabelSelection = this.peakLabelGroup
        .selectAll('.chart-peak-label')
        .data(this.filterDataRelativeToPeakByRange(chunks, 3), function(d, i) {
          return d.key + i + Math.random();
        });

      const currentPeakLabels = this.peakLabelSelection
        .enter()
        .append('g')
        .attr('class', 'chart-peak-label');

      currentPeakLabels
        .append('rect')
        .attr('width', 1)
        .attr('height', PEAK_LABEL_LINE_HEIGHT)
        .attr('fill', '#999')
        .attr('shape-rendering', 'crispEdges');
      
      currentPeakLabels
        .append('text')
        .attr('y', '-15')
        .attr('fill', '#3A3A3A')
        .attr('text-anchor', 'start')
        .attr('dominant-baseline', 'text-before-edge')
        .text(function(d, i) {
          return d.title;
        })
        .attr('transform', function(d) {
          const w = this.getComputedTextLength();
          return `translate(${-(w/2)}, 0)`
        });
      
      currentPeakLabels
        .merge(this.peakLabelSelection)
        .attr('transform', function(d) {
          const obj = d.items.slice().sort(function(a, b) { return a.interest - b.interest })[d.items.length - 1];
          return `translate(${self.mainX(new Date(obj.time)) + CHART_PADDING + 1.5}, ${self.mainY(obj.interest) - (CHART_PADDING / 2)})`;
        });

      this.peakLabelSelection
        .exit()
        .remove();
    }

    this.timelineChart.drawDots = function() {
      var self = this;

      this.dotsGroup = this.mainChartSvg.append('g').attr('class', 'dots-group');
      this.dotsSelection = this.dotsGroup.selectAll('.dots')
        .data(this.filterDataByRange(overallData))
        .enter()
        .append('circle')
        .attr('class', 'dots');

      this.dotsSelection
        .attr('r', 5)
        .attr('cx', function (d) {
            return self.mainX(new Date(d.time)) + CHART_PADDING + 2;
        })
        .attr('cy', function (d) {
            return self.mainY(d.interest) + 8;
        })
        .style('fill', function (d, i) {
          const id = d.id;
          return generateColor(parseInt(id, 10) - 1);
        })
        .style('opacity', DOT_OPACITY_OFF)
        .on('mouseover', function (d) {
          self.mouseOverDot(d.id);
        })
        .on('mouseout', function (d) {
          self.mouseOutDot(d.id);
        });
    }

    this.timelineChart.updateDots = function() {
      var self = this;
      this.dotsSelection = this.dotsGroup
        .selectAll('.dots')
        .data(this.filterDataByRange(overallData), function(d, i) {
          return d.key + i + Math.random();
        });

      this.dotsSelection
        .enter()
        .append('circle')
        .attr('class', 'dots')
        .attr('r', 5)
        .merge(this.dotsSelection)
        .attr('cx', function (d) {
            return self.mainX(new Date(d.time)) + CHART_PADDING + 2;
        })
        .attr('cy', function (d) {
            return self.mainY(d.interest) + 8;
        })
        .style('fill', function (d, i) {
          const id = d.id;
          return generateColor(parseInt(id, 10) - 1);
        })
        .style('opacity', DOT_OPACITY_OFF)
        .on('mouseover', function (d) {
          self.mouseOverDot(d.id);
        })
        .on('mouseout', function (d) {
          self.mouseOutDot(d.id);
        });

      this.dotsSelection
        .exit()
        .remove();

    }

    this.timelineChart.mouseOverArea = function(key) {
      this.mainChartPath
        .style('opacity', function(d) {
          if (key === d.key) {
            return MAIN_CHART_OPACITY_ON;
          }
          return MAIN_CHART_OPACITY_OFF;
        });

      this.peakLabelGroup
        .selectAll('.chart-peak-label')
        .style('opacity', function(d) {
          if (key === d.key) {
            return DOT_OPACITY_ON;
          }
          return DOT_OPACITY_OFF;
        });

      this.dotsGroup
        .selectAll('.dots')
        .style('opacity', function(d) {
          if (key === d.id) {
            return DOT_OPACITY_ON;
          }
          return DOT_OPACITY_OFF;
        });
    }

    this.timelineChart.mouseOutArea = function(key) {
      this.mainChartPath
        .style('opacity', function(d) {
          return MAIN_CHART_OPACITY_ON;
        });

      this.peakLabelGroup
        .selectAll('.chart-peak-label')
        .style('opacity', function(d) {
          return DOT_OPACITY_ON;
        });

      this.dotsGroup
        .selectAll('.dots')
        .style('opacity', function(d) {
          return DOT_OPACITY_OFF;
        });
    }

    this.timelineChart.mouseOverDot = function(key) {
      this.dotsGroup
        .selectAll('.dots')
        .style('opacity', function(d) {
          if (key === d.id) {
            return DOT_OPACITY_ON;
          }
          return DOT_OPACITY_OFF;
        });

      this.peakLabelGroup
        .selectAll('.chart-peak-label')
        .style('opacity', function(d) {
          if (key === d.key) {
            return DOT_OPACITY_ON;
          }
          return DOT_OPACITY_OFF;
        });

      this.mainChartPath
        .style('opacity', function(d) {
          if (key === d.key) {
            return MAIN_CHART_OPACITY_ON;
          }
          return MAIN_CHART_OPACITY_OFF;
        });
    }

    this.timelineChart.mouseOutDot = function(key) {
      console.log(key);
    }

    this.timelineChart.drawMainXAxis = function() {
      this.xAxisScale = d3.scaleLinear()
        .domain([minDate, maxDate])
        .range([0, this.svgWidth]);

      this.xAxis = d3
        .axisBottom(this.xAxisScale)
        .tickSize(8, 0)
        .ticks(d3.timeWeek)
        .scale(this.mainX)
        .tickFormat(d3.timeFormat('%B %d %Y'));

      this.xAxisGroup = this.mainChartGroup
        .append('g')
        .attr('transform', `translate(${CHART_PADDING}, ${CHART_HEIGHT})`)
        .call(this.xAxis);
    }

    this.timelineChart.drawMainYAxis = function() {
      this.yAxisScale = d3.scaleLinear()
        .domain([1, 0])
        .range([0, CHART_HEIGHT])
    
      this.yAxis = d3
        .axisLeft(this.yAxisScale)
        .tickValues([0, 0.5, 1])
        .tickFormat(d3.format(',.1r'));

      this.yAxisGroup = this.mainChartGroup
        .append('g')
        .attr('transform', `translate(${CHART_PADDING}, 0)`)
        .call(this.yAxis);
    }

    this.timelineChart.initTimeline = function() {
      var self = this;
      this.drawTimelineChart();
      this.drawTimelineBrush();
    }

    this.timelineChart.updateBrushPosition = function() {
      this.timelineBrushGroup.call(
        this.timelineBrush.move,
        [this.timelineX(this.selectedMinDate), this.timelineX(this.selectedMaxDate)],
      );
    }

    this.timelineChart.brushed = function(_this) {
      const selection = d3.event.selection;
      const selectedDate = new Date(_this.timelineX.invert(selection[0]));
      const selectedDateMax = new Date(_this.timelineX.invert(selection[1]));

      this.timelineMinSelectionMask
        .attr('width', selection[0]);
      this.timelineMaxSelectionMask
        .attr('x', selection[1])
        .attr('width', (_this.timelineX.range()[1] - selection[1] > 0 ? _this.timelineX.range()[1] - selection[1] : 0)) + CHART_PADDING;

      this.timelineMinSelection.attr('x', selection[0]);
      this.timelineMaxSelection.attr('x', selection[1] - 1);

      if (d3.event.sourceEvent) {
        this.updateMainChart(selectedDate);
      }
    }

    this.timelineChart.updateMainChart = function(startDate) {
      var self = this;
      this.selectedMinDate = startDate;
      this.selectedMaxDate = addDays(startDate, DAYS_RANGE);

      this.mainX.domain([this.selectedMinDate, this.selectedMaxDate]);

      this.mainChartArea.defined(function(d) {
        return addDays(new Date(d.time), 1) >= self.selectedMinDate && addDays(new Date(d.time), -1) <= self.selectedMaxDate;
      });

      this.mainChartPath
        .attr('d', function (d) {
            return self.mainChartArea(d.items);
        });

      this.xAxisGroup.call(this.xAxis);
      this.updatePeakLabels();
      this.updateDots();
    }

    this.timelineChart.drawTimelineBrush = function() {
      var self = this;
      const brushWidth = this.svgWidth - CHART_PADDING;

      this.timelineBrush = d3.brushX()
        .extent([[0, 0], [brushWidth, BRUSH_HEIGHT]])
        .on('brush end', function () {
          self.brushed(self); 
        });

      this.timelineBrushGroup = this.timelineSvg
        .append('g')
        .attr('class', 'timeline-brush')
        .call(this.timelineBrush);

      this.timelineBrushGroup.select('.selection')
        .attr('fill-opacity', 0)
        .attr('stroke', 'none');

      this.timelineBrushGroup.selectAll('.handle').remove();
      this.timelineBrushGroup.selectAll('.overlay').remove();

      // Selected area's left line
      this.timelineMinSelection = this.timelineBrushGroup
        .append('rect')
        .attr('class', 'timeline-chart-min-selection')
        .attr('x', '0')
        .attr('y', '0')
        .attr('width', '1')
        .attr('height', BRUSH_HEIGHT)
        .attr('fill', '#3A3A3A')
        .attr('shape-rendering', 'crispEdges');

      // Selected area's right line
      this.timelineMaxSelection = this.timelineBrushGroup
        .append('rect')
        .attr('class', 'timeline-chart-max-selection')
        .attr('x', `${this.timelineX.range()[1] - 1}`)
        .attr('y', '0')
        .attr('width', '1')
        .attr('height', BRUSH_HEIGHT)
        .attr('fill', '#3A3A3A')
        .attr('shape-rendering', 'crispEdges');

      // Overlay for timeline's left side mask
      this.timelineMinSelectionMask = this.timelineBrushGroup
        .append('rect')
        .attr('x', '0')
        .attr('y', '0')
        .attr('width', '0')
        .attr('height', BRUSH_HEIGHT)
        .attr('fill', '#FFFFFF')
        .attr('fill-opacity', '0.75')
        .attr('shape-rendering', 'crispEdges');

      // Overlay for timeline's right side mask
      this.timelineMaxSelectionMask = this.timelineBrushGroup
        .append('rect')
        .attr('x', `${brushWidth}`)
        .attr('y', '0')
        .attr('width', '0')
        .attr('height', BRUSH_HEIGHT)
        .attr('fill', '#FFFFFF')
        .attr('fill-opacity', '0.75')
        .attr('shape-rendering', 'crispEdges');

      self.updateBrushPosition();
    }

    this.timelineChart.drawTimelineChart = function() {
      var self = this;
      const brushWidth = this.svgWidth - CHART_PADDING;

      this.timelineSvg = d3
        .select('.timeline-chart')
        .append('svg')
        .attr('transform', `translate(${CHART_PADDING / 2}, 0)`)
        .attr('width', brushWidth)
        .attr('height', BRUSH_HEIGHT);

      const bottomLine = this.timelineSvg
        .append('line')
        .attr('x1', '0')
        .attr('y1', `${BRUSH_HEIGHT - 1}`)
        .attr('x2', `${brushWidth}`)
        .attr('y2', `${BRUSH_HEIGHT - 1}`)
        .attr('stroke', '#E7E7E7')
        .attr('stroke-width', '1')
        .attr('shape-rendering', 'crispEdges');
      
      const leftLine = this.timelineSvg
        .append('line')
        .attr('x1', '1')
        .attr('y1', '0')
        .attr('x2', '1')
        .attr('y2', `${BRUSH_HEIGHT}`)
        .attr('stroke', '#E7E7E7')
        .attr('stroke-width', '1')
        .attr('shape-rendering', 'crispEdges');

      const rightLine = this.timelineSvg
        .append('line')
        .attr('x1', `${brushWidth - 1}`)
        .attr('y1', '0')
        .attr('x2', `${brushWidth - 1}`)
        .attr('y2', `${BRUSH_HEIGHT}`)
        .attr('stroke', '#E7E7E7')
        .attr('stroke-width', '1')
        .attr('shape-rendering', 'crispEdges');

      this.timelineChartGroup = this.timelineSvg
        .append('g')
        .attr('class', 'timeline-chart-group');

      this.timelineChartSelection = this.timelineChartGroup
        .selectAll('path')
        .data(chunks)
        .enter();

      this.timelineChartArea = d3.area()
        .x(function(d, i) { return self.timelineX(new Date(d.time)); })
        .y0(self.timelineY(0))
        .y1(function(d, i) { return self.timelineY(d.interest) });

      this.timelineChartPath = this.timelineChartSelection
      .append('path')
      .attr('fill', function(d, i) {
        return generateColor(i);
      })
      .datum(function(d) { return d; })
      .attr("d", function(d) {
        return self.timelineChartArea(d.items);
      })
    }
    this.timelineChart.initMainChart();
    this.timelineChart.initTimeline();
    const timelineChart = this.timelineChart;
    window.addEventListener('resize', function(e) {
      timelineChart.resize(e);
    });
  </script>
</html>